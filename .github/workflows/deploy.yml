name: Deploy
run-name: "ğŸš€ Deploy by ${{ github.actor }} to CBM-MALL FRONTEND [${{ github.ref_name }}]"

on:
  push:
    branches:
      - main
      - staging
  workflow_dispatch:

jobs:
  deploy-staging:
    if: github.ref == 'refs/heads/staging'
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¦ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”‘ Setup SSH Agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ğŸš€ Deploy to Staging Server
        run: |
          ssh -o StrictHostKeyChecking=no -p 22 ${{ secrets.SSH_USER }}@50.116.38.113 << 'ENDSSH'
          set -e
          echo "ğŸ” Logged in via SSH"
          
          cd /var/www/cbm-mall-store-staging
          echo "ğŸ“‚ Working directory: $(pwd)"
          
          echo "ğŸ“¥ Fetching and updating staging branch..."
          git config --global --add safe.directory /var/www/cbm-mall-store-staging
          git fetch origin staging
          git reset --hard origin/staging
          git clean -fd
          
          echo "ğŸ“Œ Current commit: $(git log -1 --oneline)"
          
          echo "ğŸ“¦ Installing dependencies..."
          npm  install 
          
          echo "âš™ï¸ Running Next.js build..."
          npm run build
          
          echo "ğŸ“ Ensuring logs directory exists..."
          mkdir -p logs
          
          if [ ! -f "ecosystem.config.js" ]; then
            echo "âš ï¸ ecosystem.config.js not found! Creating..."
            cat > ecosystem.config.js << 'ECOEND'
          module.exports = {
            apps: [{
              name: "cbm-mall-store-staging",
              script: "npm",
              args: "run start",
              cwd: "/var/www/cbm-mall-store-staging",
              env: {
                NODE_ENV: "staging",
                PORT: 3000,
              },
              instances: 1,
              autorestart: true,
              watch: false,
              max_memory_restart: "1G",
              error_file: "/var/www/cbm-mall-store-staging/logs/error.log",
              out_file: "/var/www/cbm-mall-store-staging/logs/out.log",
              log_date_format: "YYYY-MM-DD HH:mm:ss Z",
            }],
          };
          ECOEND
          fi
          
          echo "ğŸ”„ Restarting PM2 staging app..."
          if pm2 describe cbm-mall-store-staging > /dev/null 2>&1; then
            echo "â™»ï¸ App exists, reloading (zero-downtime)..."
            pm2 reload ecosystem.config.js --only cbm-mall-store-staging --update-env
          else
            echo "ğŸ†• App doesn't exist, starting fresh..."
            pm2 start ecosystem.config.js --only cbm-mall-store-staging
          fi
          
          echo "ğŸ’¾ Saving PM2 process list..."
          pm2 save --force
          
          echo "ğŸ“Š PM2 Status:"
          pm2 list
          
          echo "â„¹ï¸ App Information:"
          pm2 describe cbm-mall-store-staging | grep -E "status|uptime|restarts|script|port" || true
          
          echo "ğŸ”Œ Port Check:"
          if ss -tlnp 2>/dev/null | grep :3000 > /dev/null; then
            echo "âœ… App is listening on port 3000"
          else
            echo "âš ï¸ Warning: Port 3000 not in use yet (app may still be starting)"
          fi
          
          echo "âœ… Staging Deployment Complete"
          ENDSSH

  deploy-production:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¦ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”‘ Setup SSH Agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ğŸš€ Deploy to Production Server
        run: |
          ssh -o StrictHostKeyChecking=no -p 22 ${{ secrets.SSH_USER }}@45.33.103.215 << 'ENDSSH'
          set -e
          echo "ğŸ” Logged in via SSH"
          
          cd /var/www/cbm-mall-store
          echo "ğŸ“‚ Working directory: $(pwd)"
          
          echo "ğŸ“¥ Fetching and updating main branch..."
          git config --global --add safe.directory /var/www/cbm-mall-store
          git fetch origin main
          git reset --hard origin/main
          git clean -fd
          
          echo "ğŸ“Œ Current commit: $(git log -1 --oneline)"
          
          echo "ğŸ“¦ Installing dependencies..."
          npm install
          
          echo "âš™ï¸ Running Next.js build..."
          npm run build
          
          echo "ğŸ“ Ensuring logs directory exists..."
          mkdir -p logs
          
          if [ ! -f "ecosystem.config.js" ]; then
            echo "âš ï¸ ecosystem.config.js not found! Creating..."
            cat > ecosystem.config.js << 'ECOEND'
          module.exports = {
            apps: [{
              name: "cbm-mall-store",
              script: "npm",
              args: "run start",
              cwd: "/var/www/cbm-mall-store",
              env: {
                NODE_ENV: "production",
                PORT: 3000,
              },
              instances: 1,
              autorestart: true,
              watch: false,
              max_memory_restart: "1G",
              error_file: "/var/www/cbm-mall-store/logs/error.log",
              out_file: "/var/www/cbm-mall-store/logs/out.log",
              log_date_format: "YYYY-MM-DD HH:mm:ss Z",
            }],
          };
          ECOEND
          fi
          
          echo "ğŸ”„ Restarting PM2 production app..."
          if pm2 describe cbm-mall-store > /dev/null 2>&1; then
            echo "â™»ï¸ App exists, reloading (zero-downtime)..."
            pm2 reload ecosystem.config.js --only cbm-mall-store --update-env
          else
            echo "ğŸ†• App doesn't exist, starting fresh..."
            pm2 start ecosystem.config.js --only cbm-mall-store
          fi
          
          echo "ğŸ’¾ Saving PM2 process list..."
          pm2 save --force
          
          echo "ğŸ“Š PM2 Status:"
          pm2 list
          
          echo "â„¹ï¸ App Information:"
          pm2 describe cbm-mall-store | grep -E "status|uptime|restarts|script|port" || true
          
          echo "ğŸ”Œ Port Check:"
          if ss -tlnp 2>/dev/null | grep :3000 > /dev/null; then
            echo "âœ… App is listening on port 3000"
          else
            echo "âš ï¸ Warning: Port 3000 not in use yet (app may still be starting)"
          fi
          
          echo "âœ… Production Deployment Complete"
          ENDSSH